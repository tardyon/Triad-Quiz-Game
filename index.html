<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Triad Quiz Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .options {
      margin-bottom: 20px;
    }
    .options label {
      margin-right: 15px;
    }
    #quiz-area {
      margin-top: 20px;
    }
    #quiz-question {
      font-size: 3em;
      margin-bottom: 30px;
    }
    #reveal-button, #correct-button, #wrong-button, #reset-button {
      margin: 10px;
      padding: 20px 30px;
      font-size: 1.5em;
      cursor: pointer;
    }
    #answer {
      font-size: 2.5em;
      margin-bottom: 30px;
      color: blue;
    }
    #progress {
      margin-top: 20px;
      font-size: 1.2em;
    }
    #start-button {
      margin-top: 20px;
      padding: 20px 30px;
      font-size: 1.5em;
      cursor: pointer;
    }
    #footer {
      margin-top: 40px;
      font-size: 0.9em;
      color: gray;
    }
    #footer p {
      margin: 5px 0;
    }
    h1, h2 {
      text-align: center;
    }
    input[type="checkbox"], input[type="radio"] {
      transform: scale(1.5);
      margin-right: 10px;
    }
    #missed-questions {
      margin-top: 20px;
    }
    #missed-questions h2 {
      font-size: 1.5em;
      margin-bottom: 10px;
    }
    #missed-list {
      list-style-type: none;
      padding: 0;
    }
    #missed-list li {
      font-size: 1.2em;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Triad Quiz Game</h1>
    <p>This game helps you practice identifying the four types of triads. If a chord doesn't match the spelling of any of these types, consider choosing a different root note. Changing game options requires a game reset to take effect.</p>
    
    <div class="options">
      <h2>Select Triad Types:</h2>
      <label><input type="checkbox" id="major" checked> Major</label>
      <label><input type="checkbox" id="minor" checked> Minor</label>
      <label><input type="checkbox" id="diminished" checked> Diminished</label>
      <label><input type="checkbox" id="augmented" checked> Augmented</label>
    </div>
    
    <div class="options">
      <h2>Select Inversions:</h2>
      <label><input type="checkbox" id="root" checked> Root Position</label>
      <label><input type="checkbox" id="first"> First Inversion</label>
      <label><input type="checkbox" id="second"> Second Inversion</label>
      <label><input type="checkbox" id="spread"> Spread Voicings</label>
    </div>
    
    <div class="options">
      <h2>Select Quiz Mode:</h2>
      <label><input type="radio" name="mode" value="name" checked> Name the Chord</label>
      <label><input type="radio" name="mode" value="spell"> Spell the Chord</label>
    </div>
    
    <button id="start-button">Start Quiz</button>
    
    <div id="quiz-area" style="display: none;">
      <div id="quiz-question"></div>
      <button id="reveal-button">Reveal Answer (Space Bar)</button>
      <div id="answer" style="display: none;"></div>
      <button id="correct-button" style="display: none;">I Was Correct ('.' Key)</button>
      <button id="wrong-button" style="display: none;">I Was Wrong (',' Key)</button>
      <button id="reset-button">Reset Game</button>
      <div id="progress"></div>
    </div>
    
    <div id="footer">
      <p>© 2024 Michael C.M. Varney</p>
      <p>Version 1.52</p>
    </div>

    <div id="missed-questions">
      <h2>Missed Questions</h2>
      <ul id="missed-list"></ul>
    </div>

  </div>
  
  <script>
    (function() {
      const circleOfFifths = [
        'C', 'G', 'D', 'A', 'E', 'B', 'F#', 'C#',
        'F', 'Bb', 'Eb', 'Ab', 'Db', 'Gb', 'Cb'
      ];

      const triadTypes = [
        { name: 'Major', formula: ['1', '3', '5'], symmetrical: false },
        { name: 'Minor', formula: ['1', 'b3', '5'], symmetrical: false },
        { name: 'Diminished', formula: ['1', 'b3', 'b5'], symmetrical: false },
        { name: 'Augmented', formula: ['1', '3', '#5'], symmetrical: true }
      ];

      let quizSet = [];
      let currentQuestionIndex = 0;
      let correctAnswers = 0;
      let incorrectAttempts = 0;
      let totalQuestions = 0;
      let missedQuestions = {};

      function initializeQuiz() {
        const selectedTypes = [];
        if (document.getElementById('major').checked) selectedTypes.push('Major');
        if (document.getElementById('minor').checked) selectedTypes.push('Minor');
        if (document.getElementById('diminished').checked) selectedTypes.push('Diminished');
        if (document.getElementById('augmented').checked) selectedTypes.push('Augmented');

        if (selectedTypes.length === 0) {
          alert('Please select at least one triad type!');
          return;
        }

        const inversionSelections = [];
        if (document.getElementById('root').checked) inversionSelections.push('root');
        if (document.getElementById('first').checked) inversionSelections.push('first');
        if (document.getElementById('second').checked) inversionSelections.push('second');
        if (document.getElementById('spread').checked) inversionSelections.push('spread');

        const modeRadios = document.getElementsByName('mode');
        let quizMode = 'name';
        for (let radio of modeRadios) {
          if (radio.checked) {
            quizMode = radio.value;
            break;
          }
        }

        quizSet = [];
        missedQuestions = {};
        circleOfFifths.forEach(root => {
          triadTypes.forEach(triadType => {
            if (selectedTypes.includes(triadType.name)) {
              const triadNotes = generateTriad(root, triadType.formula);
              if (!triadNotes) return;
              inversionSelections.forEach(inversionType => {
                const permutations = generatePermutations(triadNotes, inversionType, triadType.symmetrical);
                permutations.forEach(perm => {
                  const questionKey = quizMode === 'name' ? perm.notes.join(' – ') : `${root} ${triadType.name} Triad (${perm.inversion})`;
                  quizSet.push({
                    question: perm.notes.join(' – '),
                    answer: `${root} ${triadType.name} Triad`,
                    inversion: perm.inversion,
                    quizMode: quizMode,
                    key: questionKey,
                    isSymmetrical: triadType.symmetrical
                  });
                });
              });
            }
          });
        });

        if (quizSet.length === 0) {
          alert('No triads available for the selected settings!');
          return;
        }

        totalQuestions = quizSet.length;
        currentQuestionIndex = 0;
        correctAnswers = 0;
        incorrectAttempts = 0;

        document.getElementById('start-button').style.display = 'none';
        document.getElementById('quiz-area').style.display = 'block';
        document.getElementById('missed-list').innerHTML = '';

        showNextQuestion();
      }

      function generateTriad(root, formula) {
        const useSharps = !root.includes('b');
        const scale = buildMajorScale(root, useSharps);
        if (!scale) return null;

        const degreeMap = {
          '1': 0,
          '2': 1,
          '3': 2,
          '4': 3,
          '5': 4,
          '6': 5,
          '7': 6
        };

        const notes = formula.map(interval => {
          let degree = interval.replace(/b|#/g, '');
          let note = scale[degreeMap[degree]];
          if (interval.includes('b')) {
            note = flattenNote(note);
          } else if (interval.includes('#')) {
            note = sharpenNote(note);
          }
          return note;
        });

        const hasSharps = notes.some(n => n.includes('#'));
        const hasFlats = notes.some(n => n.includes('b'));
        if (hasSharps && hasFlats) return null;

        return notes;
      }

      function flattenNote(note) {
        if (note.endsWith('bb')) return note;
        if (note.endsWith('b')) return note.replace('b', 'bb');
        if (note.endsWith('#')) return note.slice(0, -1);
        if (note.endsWith('##')) return note.replace('##', '#');
        return note + 'b';
      }

      function sharpenNote(note) {
        if (note.endsWith('##')) return note;
        if (note.endsWith('#')) return note.replace('#', '##');
        if (note.endsWith('b')) return note.slice(0, -1);
        if (note.endsWith('bb')) return note.replace('bb', 'b');
        return note + '#';
      }

      function buildMajorScale(root, useSharps) {
        const semitones = [0, 2, 4, 5, 7, 9, 11];
        const scale = [];
        const rootIndex = 'CDEFGAB'.indexOf(root.charAt(0));
        for (let i = 0; i < 7; i++) {
          const letter = 'CDEFGAB'[(rootIndex + i) % 7];
          const midi = (semitoneMap[root] + semitones[i]) % 12;
          const noteName = findNoteName(letter, midi, useSharps);
          if (!noteName) return null;
          scale.push(noteName);
        }
        return scale;
      }

      const semitoneMap = {
        'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'F': 5,
        'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11
      };

      function findNoteName(letter, midi, useSharps) {
        const accidentals = useSharps ? ['', '#', '##', 'b', 'bb'] : ['bb', 'b', '', '#', '##'];
        for (let accidental of accidentals) {
          const noteName = letter + accidental;
          if (semitoneMap[noteName] !== undefined && semitoneMap[noteName] % 12 === midi) {
            return noteName;
          }
        }
        return null;
      }

      function generatePermutations(notes, inversionType, isSymmetrical) {
        const permutations = [];
        const inversions = [];

        if (isSymmetrical) {
          permutations.push(notes);
          inversions.push('No Inversions (Symmetrical Chord)');
        } else {
          if (inversionType === 'root') {
            permutations.push(notes);
            inversions.push('Root Position');
          }
          if (inversionType === 'first') {
            permutations.push([notes[1], notes[2], notes[0]]);
            inversions.push('First Inversion');
          }
          if (inversionType === 'second') {
            permutations.push([notes[2], notes[0], notes[1]]);
            inversions.push('Second Inversion');
          }
          if (inversionType === 'spread') {
            const allPermutations = permute(notes);
            allPermutations.forEach(perm => {
              if (!isStandardInversion(perm, notes)) {
                permutations.push(perm);
                inversions.push('Spread Voicing');
              }
            });
          }
        }

        const uniquePermutations = [];
        const uniqueInversions = [];
        const seen = new Set();
        for (let i = 0; i < permutations.length; i++) {
          const key = permutations[i].join('-');
          if (!seen.has(key)) {
            seen.add(key);
            uniquePermutations.push(permutations[i]);
            uniqueInversions.push(inversions[i]);
          }
        }

        return uniquePermutations.map((perm, idx) => ({
          notes: perm,
          inversion: uniqueInversions[idx]
        }));
      }

      function permute(arr) {
        const result = [];

        function generate(n, heapArr) {
          if (n === 1) {
            result.push(heapArr.slice());
          } else {
            for (let i = 0; i < n; i++) {
              generate(n - 1, heapArr);
              const j = n % 2 === 0 ? i : 0;
              [heapArr[n - 1], heapArr[j]] = [heapArr[j], heapArr[n - 1]];
            }
          }
        }

        generate(arr.length, arr.slice());
        return result;
      }

      function isStandardInversion(perm, original) {
        return (
          (perm[0] === original[0] && perm[1] === original[1] && perm[2] === original[2]) ||
          (perm[0] === original[1] && perm[1] === original[2] && perm[2] === original[0]) ||
          (perm[0] === original[2] && perm[1] === original[0] && perm[2] === original[1])
        );
      }

      function showNextQuestion() {
        if (quizSet.length === 0) {
          document.getElementById('quiz-question').textContent = 'Quiz Completed!';
          document.getElementById('reveal-button').style.display = 'none';
          document.getElementById('correct-button').style.display = 'none';
          document.getElementById('wrong-button').style.display = 'none';
          document.getElementById('answer').style.display = 'none';
          document.getElementById('progress').textContent = `Final Score: ${correctAnswers} Correct, ${incorrectAttempts} Incorrect Attempts`;
          return;
        }

        currentQuestion = quizSet[currentQuestionIndex];
        document.getElementById('quiz-question').textContent = `What is the chord for: ${currentQuestion.question}?`;
        document.getElementById('answer').style.display = 'none';
        document.getElementById('correct-button').style.display = 'none';
        document.getElementById('wrong-button').style.display = 'none';
        document.getElementById('reveal-button').style.display = 'inline-block';
        document.getElementById('progress').textContent = `Correct: ${correctAnswers}, Incorrect Attempts: ${incorrectAttempts}, Remaining Questions: ${quizSet.length}`;
      }

      function revealAnswer() {
        document.getElementById('answer').textContent = `Answer: ${currentQuestion.answer} (${currentQuestion.inversion})`;
        document.getElementById('answer').style.display = 'block';
        document.getElementById('correct-button').style.display = 'inline-block';
        document.getElementById('wrong-button').style.display = 'inline-block';
        document.getElementById('reveal-button').style.display = 'none';
      }

      function handleCorrect() {
        correctAnswers++;
        quizSet.splice(currentQuestionIndex, 1);
        if (currentQuestionIndex >= quizSet.length) {
          currentQuestionIndex = 0;
        }
        showNextQuestion();
      }

      function handleWrong() {
        incorrectAttempts++;
        const key = currentQuestion.key;
        if (missedQuestions[key]) {
          missedQuestions[key]++;
        } else {
          missedQuestions[key] = 1;
        }
        updateMissedQuestions();
        currentQuestionIndex++;
        if (currentQuestionIndex >= quizSet.length) {
          currentQuestionIndex = 0;
        }
        showNextQuestion();
      }

      function updateMissedQuestions() {
        const missedList = document.getElementById('missed-list');
        missedList.innerHTML = '';
        for (const [question, count] of Object.entries(missedQuestions)) {
          const li = document.createElement('li');
          li.textContent = `${question} - Missed ${count} time(s)`;
          missedList.appendChild(li);
        }
      }

      function resetGame() {
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('start-button').style.display = 'inline-block';
        document.getElementById('reveal-button').style.display = 'inline-block';
        document.getElementById('correct-button').style.display = 'none';
        document.getElementById('wrong-button').style.display = 'none';
        document.getElementById('answer').style.display = 'none';
        document.getElementById('quiz-question').textContent = '';
        document.getElementById('progress').textContent = '';
        document.getElementById('missed-list').innerHTML = '';
        missedQuestions = {};
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      document.getElementById('start-button').addEventListener('click', initializeQuiz);
      document.getElementById('reveal-button').addEventListener('click', revealAnswer);
      document.getElementById('correct-button').addEventListener('click', handleCorrect);
      document.getElementById('wrong-button').addEventListener('click', handleWrong);
      document.getElementById('reset-button').addEventListener('click', resetGame);

      document.addEventListener('keydown', function(event) {
        if (event.key === ' ') {
          event.preventDefault();
          if (document.getElementById('reveal-button').style.display !== 'none') {
            revealAnswer();
          }
        } else if (event.key === '.') {
          if (document.getElementById('correct-button').style.display !== 'none') {
            handleCorrect();
          }
        } else if (event.key === ',') {
          if (document.getElementById('wrong-button').style.display !== 'none') {
            handleWrong();
          }
        }
      });

    })();
  </script>
  
</body>
</html>
